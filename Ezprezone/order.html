<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Order — EZPREZONE</title>
    <link rel="stylesheet" href="CSS/common.css" />
    <link rel="stylesheet" href="CSS/Order.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
  </head>
  <body class="page-transition preload">
    <header class="navbar" role="banner">
      <a href="index.html" class="logo-link">
        <img
          class="logo"
          src="images/B5/ezprezone-logo.jpg"
          alt="EZPREZONE Logo"
        />
      </a>

      <nav role="navigation" aria-label="Main navigation">
        <ul class="nav-links">
          <li><a href="index.html">Home</a></li>
          <li><a href="aboutus.html">About</a></li>
          <li><a href="menu.html">Menu</a></li>
          <li><a href="loyaltycard.html">Loyalty</a></li>
          <li><a href="contacts.html">Contact</a></li>
          <li>
            <a href="order.html" class="active" aria-current="page">Order</a>
          </li>
          <li id="authLinks"><a href="/myprojects/auth/login.php">Login</a> | <a href="/myprojects/auth/signup.php">Sign up</a></li>
        </ul>
      </nav>

      <div class="location-btn">
        <i class="fas fa-map-marker-alt" aria-hidden="true"></i>
        <a class="aRemove" href="contacts.html#findourlocation"
          ><span class="findLocation">Find our location</span></a
        >
      </div>
    </header>

    <main class="order-page">
      <h1 class="order-title fade">Place Your Order</h1>

      <div class="order-layout">
        <section class="gallery-panel">
          <h2>Your Items</h2>
          <div id="gallery" class="order-gallery">
            <!-- gallery rendered from cart -->
          </div>
          <p class="hint smaller">Click an item to focus in the cart. Use + / − to adjust quantity.</p>
        </section>

        <aside class="cart-panel">
          <h2 id="cartTitle">Cart</h2>
          <div id="cartList" class="cart-list">
            <p class="empty">Your cart is empty</p>
          </div>

          <div class="cart-summary">
            <div class="summary-row">
              <span>Subtotal</span>
              <span id="subtotal" aria-live="polite" aria-atomic="true"
                >₱0.00</span
              >
            </div>

            <div class="payment-section">
              <h3>Payment Method</h3>
              <label
                ><input
                  type="radio"
                  name="payment"
                  value="over-the-counter"
                  checked
                />
                Over-the-counter</label
              >
              <label
                ><input type="radio" name="payment" value="gcash" />
                GCash</label
              >
              <label
                ><input type="radio" name="payment" value="paymaya" />
                PayMaya</label
              >

              <div id="paymentDetails" class="payment-details">
                <!-- dynamic fields appear here for GCash/PayMaya -->
              </div>
            </div>

            <div class="customer-section">
              <h3>Your details</h3>
              <input id="custName" type="text" placeholder="Full name" />
              <input
                id="custContact"
                type="text"
                placeholder="Phone / Contact"
              />
            </div>

            <button id="placeOrder" class="button">Place Order</button>
            <p id="orderMessage" class="order-message"></p>
          </div>
        </aside>
      </div>
    </main>

    <footer class="footer">
      <p>© 2025 Ezprezo. All Rights Reserved.</p>
    </footer>

    <div id="toast" class="toast" role="status" aria-live="polite"></div>

    <script>
      // Known items (fallback data)
      const items = [
        { id: "espresso", name: "Espresso", price: 60 },
        { id: "americano", name: "Americano", price: 70 },
        { id: "latte", name: "Latte", price: 95 },
        { id: "matcha-latte", name: "Matcha Latte", price: 110 },
        { id: "croffle", name: "Croffle Classic", price: 120 },
        { id: "pasta", name: "Pasta Alfredo", price: 150 },
      ];

      const galleryEl = document.getElementById('gallery');
      const cartList = document.getElementById("cartList");
      const subtotalEl = document.getElementById("subtotal");
      const paymentDetails = document.getElementById("paymentDetails");
      const placeOrderBtn = document.getElementById("placeOrder");
      const orderMessage = document.getElementById("orderMessage");

      // attempt to resolve image URL for an item id; returns Promise that resolves with URL or null
      function resolveImageFor(id){
        const candidates = [
          `images/ezprezo/${id}.png`,
          `images/ezprezo/${id}.jpg`,
          `images/non-ezprezo/${id}.png`,
          `images/non-ezprezo/${id}.jpg`,
          `images/signature-ezprezo/${id}.png`,
          `images/signature-ezprezo/${id}.jpg`,
          `images/matcha/${id}.jpg`,
          `images/croffle/${id}.jpg`,
          `images/pasta/${id}.jpg`,
        ];
        return new Promise((resolve)=>{
          let i = 0;
          function tryOne(){
            if(i>=candidates.length){ resolve(null); return; }
            const url = candidates[i++];
            const img = new Image();
            img.onload = ()=> resolve(url);
            img.onerror = tryOne;
            img.src = url;
          }
          tryOne();
        });
      }
      orderMessage.setAttribute("role", "status");

      let cart = {};

      function formatMoney(n) {
        return "₱" + n.toFixed(2);
      }

      function showToast(msg) {
        let t = document.getElementById("toast");
        if (!t) {
          t = document.createElement("div");
          t.id = "toast";
          t.className = "toast";
          t.setAttribute("role", "status");
          t.setAttribute("aria-live", "polite");
          document.body.appendChild(t);
        }
        t.textContent = msg;
        t.classList.add("show");
        setTimeout(() => t.classList.remove("show"), 2400);
      }

      // removed menu rendering — this page now shows an interactive gallery of ordered items
      async function renderGallery(){
        galleryEl.innerHTML = '';
        const keys = Object.keys(cart);
        if(keys.length === 0){
          galleryEl.innerHTML = '<p class="empty">No items yet — add from Menu</p>';
          return;
        }
        // render each cart item as an interactive image card
        for(const k of keys){
          const it = cart[k];
          const card = document.createElement('button');
          card.type = 'button';
          card.className = 'gallery-item card';
          card.dataset.id = it.id;
          const imgUrl = await resolveImageFor(it.id);
          const imgPart = imgUrl ? `<img src="${imgUrl}" alt="${it.name}"/>` : `<div class="placeholder">${(it.name.split(' ')[0]||'Item').charAt(0)}</div>`;
          card.innerHTML = `
            <div class="imgWrap">${imgPart}</div>
            <div class="meta">
              <strong>${it.name}</strong>
              <div class="qtyBubble">Qty: <span class="q">${it.qty}</span></div>
            </div>
            <div class="gallery-controls">
              <button class="smallBtn decrease" aria-label="Decrease ${it.name}">−</button>
              <button class="smallBtn increase" aria-label="Increase ${it.name}">+</button>
              <button class="smallBtn removeItem" aria-label="Remove ${it.name}">✕</button>
            </div>
          `;
          galleryEl.appendChild(card);
          // attach handlers
          card.querySelector('.increase').addEventListener('click', (e)=>{ e.stopPropagation(); updateQty(it.id, it.qty+1); });
          card.querySelector('.decrease').addEventListener('click', (e)=>{ e.stopPropagation(); updateQty(it.id, Math.max(0, it.qty-1)); });
          card.querySelector('.removeItem').addEventListener('click', (e)=>{ e.stopPropagation(); removeFromCart(it.id); });
          card.addEventListener('click', ()=>{
            // focus corresponding cart item
            const el = Array.from(document.querySelectorAll('.cart-item')).find(node => node.querySelector('.cart-qty')?.dataset.id === it.id);
            if(el){ el.scrollIntoView({behavior:'smooth', block:'center'}); el.classList.add('highlight'); setTimeout(()=>el.classList.remove('highlight'),900); const inp = el.querySelector('.cart-qty'); if(inp) inp.focus(); }
          });
        }
      }

      function addToCart(id, qty = 1) {
        const item = items.find((i) => i.id === id);
        if (!item) return;
        cart[id] = cart[id] || { ...item, qty: 0 };
        cart[id].qty += qty;
        renderCart();
      }

      function removeFromCart(id) {
        const name = cart[id] && cart[id].name ? cart[id].name : "Item";
        delete cart[id];
        renderCart();
        showToast(name + " removed");
      }

      function updateQty(id, qty) {
        if (qty <= 0) {
          removeFromCart(id);
          return;
        }
        cart[id].qty = qty;
        renderCart();
        const name = cart[id] && cart[id].name ? cart[id].name : "Item";
        showToast(name + " quantity updated");
      }

      function renderCart() {
        cartList.innerHTML = "";
        const keys = Object.keys(cart);
        if (keys.length === 0) {
          cartList.innerHTML = '<p class="empty">Your cart is empty</p>';
          subtotalEl.textContent = formatMoney(0);
          placeOrderBtn.disabled = true;
          saveCartToLocalStorage();
          updateCartBadge();
          renderGallery();
          return;
        }
        let sum = 0;
        keys.forEach((k) => {
          const it = cart[k];
          const row = document.createElement("div");
          row.className = "cart-item";
          const total = it.price * it.qty;
          sum += total;
          row.innerHTML = `
            <div class="left">
              <strong>${it.name}</strong>
              <div class="small"><span class="qty-wrap">x <input type="number" min="1" value="${
                it.qty
              }" class="cart-qty" data-id="${
            it.id
          }" /></span><span class="unit-price" aria-hidden="true">${formatMoney(
            it.price
          )}</span></div>
            </div>
            <div class="right">
              <span class="item-total" aria-label="Item total">${formatMoney(
                total
              )}</span>
              <button class="remove" data-id="${it.id}" aria-label="Remove ${
            it.name
          }">✕</button>
            </div>
          `;
          cartList.appendChild(row);
        });
        subtotalEl.textContent = formatMoney(sum);
        placeOrderBtn.disabled = false;

        // events for qty and remove
        cartList.querySelectorAll(".cart-qty").forEach((inp) => {
          inp.addEventListener("change", (e) => {
            const id = e.target.dataset.id;
            let q = parseInt(e.target.value || 1, 10);
            if (isNaN(q) || q < 1) q = 1;
            updateQty(id, q);
          });
        });
        cartList.querySelectorAll(".remove").forEach((btn) => {
          btn.addEventListener("click", (e) => removeFromCart(btn.dataset.id));
        });
        // persist cart
        saveCartToLocalStorage();
        renderGallery();
      }

      function saveCartToLocalStorage() {
        try {
          localStorage.setItem("ezCart", JSON.stringify(cart));
        } catch (e) {}
        updateCartBadge();
      }

      function loadCartFromLocalStorage() {
        try {
          const saved = localStorage.getItem("ezCart");
          if (!saved) return;
          const obj = JSON.parse(saved);
          cart = {};
          Object.values(obj).forEach((it) => {
            cart[it.id] = it;
          });
        } catch (e) {}
      }

      function updateCartBadge() {
        const count = Object.values(cart).reduce(
          (s, it) => s + (it.qty || 0),
          0
        );
        document.querySelectorAll(".cart-count").forEach((el) => {
          el.textContent = count;
          el.classList.add("pop");
          setTimeout(() => el.classList.remove("pop"), 220);
        });
      }

      // Payment method logic
      function handlePaymentChange() {
        const method = document.querySelector(
          'input[name="payment"]:checked'
        ).value;
        paymentDetails.innerHTML = "";
        if (method === "gcash" || method === "paymaya") {
          const label = document.createElement("label");
          label.textContent = "Reference Phone / Transaction ID (required)";
          const input = document.createElement("input");
          input.type = "text";
          input.id = "paymentRef";
          input.placeholder =
            method === "gcash"
              ? "GCash phone number / ref"
              : "PayMaya phone number / ref";
          paymentDetails.appendChild(label);
          paymentDetails.appendChild(input);
        } else {
          const p = document.createElement("p");
          p.textContent = "Pay at the counter when you pick up your order.";
          paymentDetails.appendChild(p);
        }
      }

      // Place order
      placeOrderBtn.addEventListener("click", () => {
        orderMessage.textContent = "";
        const keys = Object.keys(cart);
        if (keys.length === 0) {
          orderMessage.textContent = "Add at least one item to the cart.";
          orderMessage.classList.add("error");
          showToast("Add at least one item to the cart.");
          return;
        }
        const name = document.getElementById("custName").value.trim();
        const contact = document.getElementById("custContact").value.trim();
        if (!name || !contact) {
          orderMessage.textContent = "Please enter your name and contact.";
          orderMessage.classList.add("error");
          showToast("Please enter your name and contact.");
          return;
        }
        const method = document.querySelector(
          'input[name="payment"]:checked'
        ).value;
        let ref = "";
        if (method === "gcash" || method === "paymaya") {
          const pRef = document.getElementById("paymentRef");
          if (!pRef || !pRef.value.trim()) {
            orderMessage.textContent =
              "Please enter payment reference for selected method.";
            orderMessage.classList.add("error");
            showToast("Please enter payment reference for selected method.");
            return;
          }
          ref = pRef.value.trim();
        }

        // build a summary
        let total = 0;
        let summary = `Order for ${name} (${contact})\nPayment: ${method}${
          ref ? " — " + ref : ""
        }\n\nItems:\n`;
        keys.forEach((k) => {
          const it = cart[k];
          summary += `${it.name} x ${it.qty} = ${formatMoney(
            it.qty * it.price
          )}\n`;
          total += it.qty * it.price;
        });
        summary += `\nTotal: ${formatMoney(total)}`;

        // show summary (replace with ajax submission back-end if needed)
        showToast("Order placed successfully!");
        // optionally show full summary in console for now
        console.info("Order summary:\n" + summary);
        orderMessage.textContent = "Order placed successfully! Thank you.";
        orderMessage.classList.remove("error");
        orderMessage.classList.add("success");
        orderMessage.setAttribute("aria-live", "polite");
        // reset
        cart = {};
        renderCart();
        document.getElementById("custName").value = "";
        document.getElementById("custContact").value = "";
        handlePaymentChange();
        localStorage.removeItem("ezCart");
        updateCartBadge();
        localStorage.removeItem("ezCart");
        updateCartBadge();
      });

      // init - load persisted cart from Menu page
      loadCartFromLocalStorage();
      renderCart();
      renderGallery();
      document
        .querySelectorAll('input[name="payment"]')
        .forEach((r) => r.addEventListener("change", handlePaymentChange));
      handlePaymentChange();
      updateCartBadge();
    </script>

    <script>
      (function () {
        const body = document.body;
        if (!body) return;
        body.classList.add("page-transition");
        window.addEventListener("DOMContentLoaded", () =>
          requestAnimationFrame(() => body.classList.remove("preload"))
        );
        document.addEventListener(
          "click",
          function (e) {
            const a = e.target.closest("a");
            if (!a) return;
            const href = a.getAttribute("href");
            if (!href) return;
            if (
              a.target === "_blank" ||
              href.indexOf("mailto:") === 0 ||
              href.indexOf("tel:") === 0 ||
              href.indexOf("javascript:") === 0
            )
              return;
            let url;
            try {
              url = new URL(href, location.href);
            } catch (err) {
              return;
            }
            if (url.origin !== location.origin) return;
            if (url.hash && url.pathname === location.pathname) return;
            if (a.hasAttribute("data-no-transition")) return;
            e.preventDefault();
            body.classList.add("preload");
            setTimeout(() => (location.href = url.href), 360);
          },
          false
        );
      })();
    </script>
  </body>
</html>
